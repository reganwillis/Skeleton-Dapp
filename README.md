# Skeleton Dapp
This is a [decentralized application](https://ethereum.org/en/dapps/) structured to be used for development purposes. It is able to make a simple transaction on a local [Ethereum](https://ethereum.org/en/) blockchain using [MetaMask](https://metamask.io/). It is intended to be used as a skeleton dapp to plug in your own smart contract and front end. It also uses [Truffle](https://www.trufflesuite.com/truffle), [Ganache](https://www.trufflesuite.com/ganache), [Webpack](https://webpack.js.org/), and [web3.js](https://web3js.readthedocs.io/en/v1.2.11/getting-started.html).

## Usage Instructions
Use [Node.js](https://nodejs.org/en/download/) to install the technologies above with

    npm install
    npm install -g ganache-cli

Download the repository as a ZIP.

Start the local ethereum blockchain with this command:

    ganache-cli
The network the ganache blockchain is running on needs to match the network specified in `truffle-config.js`.

In a separate terminal, navigate to the repository and compile and deploy the smart contracts with:

    truffle compile
    truffle migrate --reset

To use the webpack configuration and start the server, run:

    npm run build
    npx webpack serve

### Connect MetaMask to the Local Blockchain
Open Chrome and click on the Extensions icon in the toolbar and select MetaMask to open it. Connect to Localhost 8545 and select to import the account with the secret recovery phrase. Use the mnemonic printed out by ganache and create a password for the local blockchain account. Click "Restore" and MetaMask should populate with the accounts from the local blockchain and be filled with ETH to be used for development purposes.

Go to http://localhost:9000/ to see the dapp. A MetaMask dialogue will pop up asking which accounts to connect to, with Account 1 already selected. If it doesn't pop up, open MetaMask from Extensions and make sure that the account is connected. Verify that it contains ETH and matches an account in the local blockchain. It will have less than 100 ETH because gas was used to deploy the smart contract. Click "Next" and "Connect".

Now the dapp is ready to be tested. Enter an integer into the form and press "INTERACT". MetaMask will pop up. Confirm the transaction to make a transaction on the local blockchain.

### Redeploy the Smart Contract when Needed
To keep everything synced up I have found that I need to delete the contents of the build folder, rerun the Truffle commands and restart the web server every time I edit the smart contract. I made a batch file to run all these steps with one command:

    run
If this step is not done this error might occur:

    Error: Returned values aren't valid, did it run Out of Gas? You might also see this error if you are not using the correct ABI for the contract you are retrieving data from, requesting data from a block number that does not exist, or querying a node which is not fully synced.

## Iterating on this Repo
To add to this dapp edit the frontend, index.js, and smart contract as explained below.

### Frontend
The `/dist` folder holds the HTML files and can hold CSS files and any other static files. It also holds the `main.js` file, which is automatically generated by Webpack and should not be edited.

### index.js
The JavaScript files are in the `/src` folder. `index.js` uses web3.js to connect to the smart contract and send and retrieve data from it. This script has three parts:

    1. initialize web3
    2. initialize the smart contract
    3. initialize the app
The third part (`initApp`) is the only part that should be changed, unless another smart contract is added to the dapp. This function interacts with the smart contract and the front end. There are links to external documentation inline in case parts 1 or 2 need to be changed. The JavaScript files in this folder will be bundled by Webpack into the `main.js` file in `/dist`.

### Smart Contract
The smart contract is `SmartContract.sol` in `/contracts`. After editing the contract, run the commands:

    truffle compile
    truffle migrate --reset

To test the smart contract, use the JS file in `/test`. There is a test for if the contract was properly deployed. There is also a template for how to write a simple test for smart contract methods. Use command `truffle test` to run your tests. Truffle has more documentation on [how to debug smart contracts](https://www.trufflesuite.com/docs/truffle/getting-started/debugging-your-contracts).

To add a new smart contract, create a sol file in the `/contracts` folder. Before running the truffle migrate command above, create a new migrations file in the `/migrations` folder. The current migrations files can serve as templates; the only changes to make to the new migrations file is the contract name:

    artifacts.require("{new contract name}")

See the [Solidity documentation](https://docs.soliditylang.org/en/v0.8.10/) for more on how to code smart contracts.

## Creation Process
These are the steps I took to create this dapp. There is more information about where code can be found and how it was created inline. My smart contract is named `SmartContract` and the naming convensions used throughout this project should be followed for new smart contracts.

### Truffle and Ganache
In a new project folder, create a base Truffle project with this command in the command prompt:
    
    truffle init

These folders and files are automatically generated:

    /contracts
        Migrations.sol
    /migrations
        1_initial_migration.js
    /test
    truffle-config.js

Add a Solidity smart contract and a migration to handle deployment:

    /contracts
        Migrations.sol
        SmartContract.sol
    /migrations
        1_initial_migration.js
        2_smart_contract.js

In order to compile and deploy the smart contract, the blockchain must be running and connected to the dapp.

Take the comments off development in truffle-config.js.

    development: {
    host: "127.0.0.1",     // Localhost (default: none)
    port: 8545,            // Standard Ethereum port (default: none)
    network_id: "*",       // Any network (default: none)
    },

In a separate command prompt, start the blockchain with:

    ganache-cli

To compile and deploy the contract, run:

    truffle compile
    truffle migrate --reset

These folders and files are automatically generated:

    /build
        /contracts
            Migrations.json
            SmartContract.json

If successful, the command line output should say that the contract has been deployed.

### Frontend Using Webpack
I used Webpack to create the frontend. This makes it easier to import and use smart contracts. Many of the below steps follow the [Getting Started](https://webpack.js.org/guides/getting-started/) tutorial.

In the command line, run:

    npm init -y
    npm install webpack webpack-cli --save-dev

These folders and files are automatically generated:

    /node_modules
    package-lock.json
    package.json

Manually create these folders and files to hold the frontend:

    /dist
        index.html
    /src
        index.js

The html file should have a script tag for `main.js`, the JavaScript file that will be created by Webpack.

Create and fill `webpack.config.js` as directed by [Using a Configuration](https://webpack.js.org/guides/getting-started/#using-a-configuration) and [NPM Scripts](https://webpack.js.org/guides/getting-started/#npm-scripts) in the tutorial.

### Development Server
Start a local server to test the dapp. The below steps use the [DevServer](https://webpack.js.org/configuration/dev-server/) webpack tutorial.

Add dev server code to webpack config:

    devServer: {
        static: {
            directory: path.join(__dirname, 'dist'),
        },
        compress: true,
        port: 9000,
    },

The path.join contents need to match the path.resolve contents in the configuration file. They should reflect the file structure of the dapp.

To start the server, run:

    npm run build
    npx webpack serve

### Web 3
Install web3.js with [the following command](https://www.oreilly.com/library/view/mastering-blockchain/9781788839044/ba606636-cbca-4bf5-acf1-0552dc6b0cd1.xhtml):

    npm install web3

To use web3.js with Webpack, the [Node Polyfill Webpack Plugin](https://github.com/Richienb/node-polyfill-webpack-plugin) is needed. Follow their README to install and use in the webpack config file.

A [circular dependancy bug](https://github.com/Richienb/node-polyfill-webpack-plugin/issues/18) with this plugin was identified in July 2021. The suggested temporary fix is to [exclude polyfilling the console](https://github.com/Richienb/node-polyfill-webpack-plugin/tree/27be8def3f3d42464fa77fd240c38a8bce982f8e#excludealiases).

Add code to `index.js` to connect to web3 and the smart contract (more detail inline). Build a simple interface in `index.html` to interact with the blockchain.

### Testing
Truffle has a [testing feature for smart contracts](https://www.trufflesuite.com/docs/truffle/testing/testing-your-contracts). In the `/test` folder, add a testing script: `smartContract.js`. Follow the steps for [writing JavaScript tests for Truffle](https://www.trufflesuite.com/docs/truffle/testing/writing-tests-in-javascript).

To run the tests, use

    truffle test